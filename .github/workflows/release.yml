```name: Release Workflow

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string
        default: 'v1.0.0'
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        type: boolean
        default: false
      generate_notes:
        description: 'Generate release notes automatically?'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '18'

jobs:
  # ========================================
  # Pre-Release Validation
  # ========================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.check_prerelease.outputs.is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          # Validate version format (semver)
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Version must follow semver format: v1.2.3"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Release version: $VERSION"

      - name: Check if prerelease
        id: check_prerelease
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ inputs.prerelease }}" == "true" ]]; then
            IS_PRERELEASE="true"
          else
            # Check version for prerelease indicators
            VERSION="${{ steps.get_version.outputs.version }}"
            if [[ "$VERSION" =~ -(alpha|beta|rc|pre|dev) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "üîî This is a prerelease"
          else
            echo "‚úÖ This is a production release"
          fi

      - name: Check for existing tag
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "‚ùå Tag $VERSION already exists"
            echo "Use a different version or delete the existing tag first"
            exit 1
          fi
          echo "‚úÖ Tag $VERSION is available"

      - name: Validate CHANGELOG
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          echo "Checking CHANGELOG.md for version $VERSION_NO_V..."

          if [ ! -f CHANGELOG.md ]; then
            echo "‚ö†Ô∏è  Warning: CHANGELOG.md not found"
          else
            if grep -q "## \[$VERSION_NO_V\]" CHANGELOG.md; then
              echo "‚úÖ Found entry for $VERSION_NO_V in CHANGELOG.md"
            else
              echo "‚ùå No entry found for $VERSION_NO_V in CHANGELOG.md"
              echo "Please add changelog entry before releasing"
              exit 1
            fi
          fi

      - name: Validate agent configurations
        run: |
          echo "Validating all agent files..."
          for file in .agents/agent/subagents/*.md .agents/agent/core.md; do
            if ! grep -q "^description:" "$file"; then
              echo "‚ùå Missing description in $file"
              exit 1
            fi
            if ! grep -q "^mode:" "$file"; then
              echo "‚ùå Missing mode in $file"
              exit 1
            fi
          done
          echo "‚úÖ All agent configurations valid"

      - name: Check documentation completeness
        run: |
          echo "Validating documentation..."

          # Required files
          required_files=("README.md" "LICENSE" "CONTRIBUTING.md" ".gitignore")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Required file missing: $file"
              exit 1
            fi
          done

          echo "‚úÖ All required documentation present"

  # ========================================
  # Comprehensive Testing
  # ========================================
  test:
    name: Comprehensive Tests
    runs-on: ubuntu-latest
    needs: validate

    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: bun install

      - name: Validate dependencies
        run: bun audit --audit-level=moderate

      - name: Run all validations
        run: |
          echo "Running comprehensive validations..."

          # Validate package structure
          if [ ! -f package.json ]; then
            echo "‚ùå package.json not found"
            exit 1
          fi

          # Validate agents structure
          if [ ! -d .agents ]; then
            echo "‚ùå .agents directory not found"
            exit 1
          fi

          echo "‚úÖ Structure validation passed"

      - name: Test agent files
        run: |
          echo "Testing agent configurations..."

          # Test core agent
          if [ ! -f .agents/agent/core.md ]; then
            echo "‚ùå Core agent missing"
            exit 1
          fi

          # Test subagents
          agent_count=$(ls -1 .agents/agent/subagents/*.md 2>/dev/null | wc -l)
          if [ $agent_count -lt 15 ]; then
            echo "‚ùå Insufficient agents: $agent_count (expected at least 15)"
            exit 1
          fi

          echo "‚úÖ Agent files validated ($agent_count agents found)"

  # ========================================
  # Generate Release Notes
  # ========================================
  notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: ${{ github.event.inputs.generate_notes != 'false' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          echo "Extracting changelog for $VERSION_NO_V..."

          # Extract changelog section
          python3 << 'EOF'
          import re
          import sys

          version = "${{ VERSION_NO_V }}"
          changelog_file = "CHANGELOG.md"

          with open(changelog_file, 'r') as f:
              content = f.read()

          # Find the version section
          pattern = rf'## \[{re.escape(version)}\].*?(?=## \[|$)'
          match = re.search(pattern, content, re.DOTALL)

          if match:
              notes = match.group(0)
              # Clean up the notes
              notes = notes.replace(f'## [{version}]', '').strip()

              # Write to file
              with open('RELEASE_NOTES.md', 'w') as f:
                  f.write(notes)

              print(f"‚úÖ Extracted {len(notes)} characters from CHANGELOG.md")
          else:
              print(f"‚ùå Could not find changelog for {version}")
              sys.exit(1)
          EOF

          # Read and display
          if [ -f RELEASE_NOTES.md ]; then
            echo ""
            echo "üìã Extracted Release Notes:"
            echo "========================"
            cat RELEASE_NOTES.md
            echo "========================"
          fi

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md

  # ========================================
  # Create Release
  # ========================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, test, notes]
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .
        continue-on-error: true

      - name: Determine release body
        id: release_body
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          IS_PRERELEASE="${{ needs.validate.outputs.is_prerelease }}"

          BODY_FILE="release_body.md"

          echo "# üéâ Release $VERSION" > "$BODY_FILE"
          echo "" >> "$BODY_FILE"

          # Add metadata
          echo "## üìä Release Information" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"
          echo "- **Version**: $VERSION" >> "$BODY_FILE"
          echo "- **Date**: $(date -u +"%Y-%m-%d")" >> "$BODY_FILE"
          echo "- **Commit**: ${{ github.sha }}" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"

          if [ "$IS_PRERELEASE" == "true" ]; then
            echo "‚ö†Ô∏è  **Note**: This is a prerelease version" >> "$BODY_FILE"
          fi

          echo "" >> "$BODY_FILE"

          # Add changelog if available
          if [ -f RELEASE_NOTES.md ]; then
            echo "## üìù What's Changed" >> "$BODY_FILE"
            echo "" >> "$BODY_FILE"
            cat RELEASE_NOTES.md >> "$BODY_FILE"
            echo "" >> "$BODY_FILE"
          else
            echo "## üìù What's Changed" >> "$BODY_FILE"
            echo "" >> "$BODY_FILE"
            echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." >> "$BODY_FILE"
            echo "" >> "$BODY_FILE"
          fi

          # Add installation instructions
          echo "## üöÄ Installation" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"
          echo "\`\`\`bash" >> "$BODY_FILE"
          echo "# Clone the repository" >> "$BODY_FILE"
          echo "git clone https://github.com/${{ github.repository }}.git" >> "$BODY_FILE"
          echo "cd cs-prof-agents" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"
          echo "# Install dependencies" >> "$BODY_FILE"
          echo "bun install" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"
          echo "# Agents are ready to use" >> "$BODY_FILE"
          echo "\`\`\`" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"

          # Add links
          echo "## üìö Documentation" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"
          echo "- [README](https://github.com/${{ github.repository }}/blob/main/README.md)" >> "$BODY_FILE"
          echo "- [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> "$BODY_FILE"
          echo "- [CONTRIBUTING](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)" >> "$BODY_FILE"
          echo "" >> "$BODY_FILE"

          # Display
          echo "üìã Generated release body:"
          echo "========================"
          cat "$BODY_FILE"
          echo "========================"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body_path: release_body.md
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release URL
        run: |
          echo "üéâ Release created successfully!"
          echo "üîó URL: ${{ steps.create_release.outputs.url }}"

  # ========================================
  # Post-Release Tasks
  # ========================================
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: release
    if: ${{ needs.validate.outputs.is_prerelease != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update main branch with release tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          echo "Ensuring main branch is up to date..."
          git fetch origin main
          git checkout main
          git pull origin main

          echo "‚úÖ Main branch updated"

      - name: Create release summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"

          echo "# üéä Release $VERSION Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: Production Release" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ‚úÖ Validation Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Version format validated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Changelog entry present" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Agent configurations valid" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Documentation complete" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üéØ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the release on GitHub" >> $GITHUB_STEP_SUMMARY
          echo "2. Update documentation if needed" >> $GITHUB_STEP_SUMMARY
          echo "3. Announce the release" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitor user feedback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create milestone for next version
        run: |
          echo "Creating placeholder for next version development..."
          # This would use GitHub CLI or API to create a new milestone
          # For now, just log the action
          CURRENT_VERSION="${{ needs.validate.outputs.version }}"
          echo "üìå Current release: $CURRENT_VERSION"
          echo "üìã Next development will follow this release"
