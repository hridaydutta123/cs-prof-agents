name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  NODE_VERSION: "18"

jobs:
  # ========================================
  # Code Quality & Linting
  # ========================================
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: bun install

      - name: Install linting tools
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint
          npm install -g markdownlint-cli

      - name: Lint YAML files
        run: |
          yaml_files=$(find . -name '*.yml' -o -name '*.yaml' | grep -v node_modules)
          if [ -n "$yaml_files" ]; then
            echo "$yaml_files" | xargs -I {} yamllint {} || true
          else
            echo "No YAML files found to lint"
          fi
        continue-on-error: true

      - name: Lint Markdown files
        run: |
          md_files=$(find . -name '*.md' -not -path './node_modules/*')
          if [ -n "$md_files" ]; then
            echo "$md_files" | xargs -I {} markdownlint {} || true
          else
            echo "No Markdown files found to lint"
          fi
        continue-on-error: true

      - name: Check agent frontmatter
        run: |
          echo "Validating agent YAML frontmatter..."
          for file in .opencode/agent/subagents/*.md .opencode/agent/core.md; do
            echo "Checking $file"
            if ! grep -q "^---" "$file" || ! grep -q "^description:" "$file"; then
              echo "‚ùå Invalid frontmatter in $file"
              exit 1
            fi
          done
          echo "‚úÖ All agent files have valid frontmatter"

  # ========================================
  # Dependency Security Scan
  # ========================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Run npm audit
        run: bun audit --audit-level=moderate
        continue-on-error: false

      - name: Check for sensitive data
        run: |
          echo "Checking for potential secrets..."
          if grep -rE "(password|api[_-]?key|secret|token)" --include="*.md" --include="*.js" --include="*.ts" --exclude-dir=node_modules --binary-files=without-match .; then
            echo "‚ö†Ô∏è  Warning: Potential secrets found"
          else
            echo "‚úÖ No obvious secrets detected"
          fi

  # ========================================
  # Documentation Validation
  # ========================================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README completeness
        run: |
          echo "Validating README.md..."
          if [ ! -f README.md ]; then
            echo "‚ùå README.md not found"
            exit 1
          fi

          # Check for required sections
          required_sections=("## üìñ Overview" "## ‚ú® Features" "## üì¶ Installation" "## üöÄ Quick Start" "## üìã Agent Capabilities")
          for section in "${required_sections[@]}"; do
            if ! grep -q "$section" README.md; then
              echo "‚ùå Missing section: $section"
              exit 1
            fi
          done

          echo "‚úÖ README.md is complete"

      - name: Check LICENSE
        run: |
          if [ ! -f LICENSE ]; then
            echo "‚ùå LICENSE file not found"
            exit 1
          fi
          echo "‚úÖ LICENSE file present"

      - name: Check agent documentation
        run: |
          echo "Validating agent documentation..."
          agent_count=$(ls -1 .opencode/agent/subagents/*.md 2>/dev/null | wc -l)
          if [ $agent_count -lt 10 ]; then
            echo "‚ùå Insufficient agent files (found $agent_count, expected at least 10)"
            exit 1
          fi
          echo "‚úÖ Found $agent_count agent files"

  # ========================================
  # Integration Tests
  # ========================================
  test:
    name: Integration Tests
    runs-on: ${{ matrix.os }}
    needs: [security, docs]

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        node-version: [18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: bun install

      - name: Validate package.json
        run: |
          echo "Validating package.json structure..."
          if ! command -v bun &> /dev/null; then
            echo "‚ùå bun command not found"
            exit 1
          fi
          echo "‚úÖ package.json is valid"

      - name: Check OpenCode configuration
        run: |
          echo "Checking OpenCode compatibility..."
          if [ ! -d .opencode ]; then
            echo "‚ùå .opencode directory not found"
            exit 1
          fi
          if [ ! -f .opencode/agent/core.md ]; then
            echo "‚ùå Core agent not found"
            exit 1
          fi
          echo "‚úÖ OpenCode structure is valid"

  # ========================================
  # Agent Configuration Validation
  # ========================================
  validate-agents:
    name: Validate Agent Configuration
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate agent files
        run: |
          echo "Validating all agent configurations..."
          exit_code=0

          # Validate core agent
          echo "Validating core agent..."
          if ! grep -q "mode: primary" .opencode/agent/core.md; then
            echo "‚ùå Core agent missing 'mode: primary'"
            exit_code=1
          fi

          # Validate subagents
          for file in .opencode/agent/subagents/*.md; do
            echo "Validating $(basename $file)..."

            # Check for required frontmatter fields
            required_fields=("description" "mode" "model" "temperature")
            for field in "${required_fields[@]}"; do
              if ! grep -q "^$field:" "$file"; then
                echo "‚ùå Missing field: $field in $file"
                exit_code=1
              fi
            done

            # Check mode is 'subagent'
            if ! grep -q "mode: subagent" "$file"; then
              echo "‚ö†Ô∏è  Warning: $file may not have correct mode"
            fi

            # Check temperature is valid (0.1-0.3)
            temp=$(grep "^temperature:" "$file" | awk '{print $2}')
            if [ -n "$temp" ]; then
              if (( $(echo "$temp < 0.1" | bc -l) )) || (( $(echo "$temp > 0.5" | bc -l) )); then
                echo "‚ö†Ô∏è  Warning: Temperature $temp may be outside typical range in $file"
              fi
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ All agent configurations are valid"
          else
            exit 1
          fi

      - name: Check agent references
        run: |
          echo "Checking agent references in core.md..."
          core_file=".opencode/agent/core.md"

          # Extract all @ references
          references=$(grep -oE '\@[^\)]+' "$core_file" | sort -u)

          if [ -z "$references" ]; then
            echo "‚ö†Ô∏è  Warning: No agent references found in core.md"
          else
            echo "Found $(echo "$references" | wc -l) agent references"

            # Validate each reference exists
            missing_refs=0
            while IFS= read -r ref; do
              ref_path="${ref#@}"
              if [ ! -f "$ref_path" ]; then
                echo "‚ùå Reference not found: $ref"
                missing_refs=$((missing_refs + 1))
              fi
            done <<< "$references"

            if [ $missing_refs -gt 0 ]; then
              echo "‚ùå $missing_refs agent references are invalid"
              exit 1
            else
              echo "‚úÖ All agent references are valid"
            fi
          fi

  # ========================================
  # Performance & Quality Checks
  # ========================================
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file sizes
        run: |
          echo "Checking for oversized files..."
          max_size=$((5 * 1024 * 1024)) # 5MB

          for file in $(find . -type f -not -path './node_modules/*' -not -path './.git/*' -not -name '*.lock'); do
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            if [ $size -gt $max_size ]; then
              echo "‚ö†Ô∏è  Warning: Large file detected: $file ($(numfmt --to=iec $size))"
            fi
          done

          echo "‚úÖ File size check complete"

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          todos=$(grep -rE "TODO|FIXME|HACK|XXX" --include="*.md" --include="*.js" --include="*.ts" --exclude-dir=node_modules --binary-files=without-match . | wc -l)
          echo "Found $todos TODO/FIXME comments"

          if [ $todos -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: $todos TODO/FIXME comments found"
          fi

      - name: Check code coverage
        run: |
          echo "Checking agent coverage..."
          agent_count=$(ls -1 .opencode/agent/subagents/*.md 2>/dev/null | wc -l)
          echo "Found $agent_count specialized agents"

          if [ $agent_count -lt 15 ]; then
            echo "‚ö†Ô∏è  Warning: Less than 15 agents found (currently $agent_count)"
          else
            echo "‚úÖ Good agent coverage: $agent_count agents"
          fi

  # ========================================
  # Build & Package Validation
  # ========================================
  build:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: [validate-agents, quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: bun install

      - name: Validate package.json
        run: bun run validate || echo "No validate script, skipping"

      - name: Build (if applicable)
        run: bun run build || echo "No build script, skipping"

      - name: Create build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Agent Count**: $(ls -1 .opencode/agent/subagents/*.md 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Status Report
  # ========================================
  report:
    name: CI/CD Report
    runs-on: ubuntu-latest
    needs: [lint, security, docs, test, validate-agents, quality, build]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate summary
        run: |
          echo "# üéì CS Professor Technical Agent Team - CI/CD Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Validate | ${{ needs.lint.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Check | ${{ needs.docs.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.test.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agent Validation | ${{ needs.validate-agents.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Validation | ${{ needs.build.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ Overall Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count successful jobs
          success_count=0
          if [ "${{ needs.lint.result }}" == "success" ]; then success_count=$((success_count+1)); fi
          if [ "${{ needs.security.result }}" == "success" ]; then success_count=$((success_count+1)); fi
          if [ "${{ needs.docs.result }}" == "success" ]; then success_count=$((success_count+1)); fi
          if [ "${{ needs.test.result }}" == "success" ]; then success_count=$((success_count+1)); fi
          if [ "${{ needs.validate-agents.result }}" == "success" ]; then success_count=$((success_count+1)); fi
          if [ "${{ needs.quality.result }}" == "success" ]; then success_count=$((success_count+1)); fi
          if [ "${{ needs.build.result }}" == "success" ]; then success_count=$((success_count+1)); fi

          echo "**$success_count/7 jobs passed**" >> $GITHUB_STEP_SUMMARY

          if [ $success_count -eq 7 ]; then
            echo "‚úÖ **All checks passed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some checks failed. Please review the logs.**" >> $GITHUB_STEP_SUMMARY
          fi
